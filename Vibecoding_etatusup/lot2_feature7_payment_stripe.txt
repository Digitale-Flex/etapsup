## ğŸ§© Feature 7 â€” Module Paiement (Stripe)

### ğŸ¯ User Story

**Story 1.7.1 â€” Paiement en ligne des frais de dossier et acompte scolaritÃ©**
*En tant quâ€™Ã©tudiant (Amina)*,
*je veux* pouvoir payer mes frais de dossier directement depuis la plateforme via Stripe,
*afin de* finaliser ma candidature et obtenir automatiquement mon reÃ§u.

**CritÃ¨res dâ€™acceptation :**

* Paiement via **Stripe Checkout** (mode test).
* Le **montant Ã  payer** correspond au champ `frais_dossier` de lâ€™Ã©tablissement.
* AprÃ¨s paiement rÃ©ussi â†’ statut dossier = â€œPayÃ©â€.
* Le reÃ§u Stripe est accessible via un lien (`receipt_url`).
* Liste des paiements visibles dans le tableau de bord Ã©tudiant.
* Champ `acompte_scolarite` prÃ©sent dans le modÃ¨le `etablissements` (prÃ©vu pour Sprint 2, pas encore actif).

### âš™ï¸ Prompt Claude â€“ ImplÃ©mentation (Sprint 1)

> **Mission globale :**
> IntÃ©grer Stripe Checkout en rÃ©utilisant la logique existante du projet clonÃ© (Yod Invest ou Mareza).
> Le paiement doit Ãªtre fluide, sÃ©curisÃ© et ne pas nÃ©cessiter de refonte.
> Avant modification, **analyse la configuration Stripe existante**, puis **adapte uniquement les parties nÃ©cessaires** pour connecter la candidature, lâ€™Ã©tablissement et le paiement.

#### ğŸ§  Analyse prÃ©alable de lâ€™existant

* Identifier :

  * `StripeController`, `PaymentController`, ou Ã©quivalent.
  * ModÃ¨le `Application`, `Payment`.
  * Routes API : `/api/v1/payments/create`, `/success`, `/cancel`.
* VÃ©rifier la configuration (`STRIPE_SECRET_KEY`, `STRIPE_PUBLIC_KEY`).
* Observer la logique webhook (`checkout.session.completed`).
* Diagnostic :

  ```bash
  // Diagnostic Sprint1 - Feature 1.7.1 :
  // ContrÃ´leur dÃ©tectÃ© : StripeController
  // Routes existantes : /api/v1/payments/create, /success, /cancel
  // DÃ©cision : conserver structure CheckoutSession + update auto statut "PayÃ©"
  ```

#### âš™ï¸ Ã‰tapes dâ€™implÃ©mentation

**A. Frontend**

* Dans `PaymentStep.vue` ou `Candidature.vue` :

  * Bouton `[Payer les frais]`.
  * Appel `POST /api/v1/payments/create` avec `application_id`, `establishment_id`, `amount`.
  * Redirection vers `session.url` Stripe.
  * Message de succÃ¨s : â€œâœ… Paiement rÃ©ussi !â€.

**B. Backend**

* Dans `StripeController` :

  ```php
  $session = \Stripe\Checkout\Session::create([
      'payment_method_types' => ['card'],
      'line_items' => [[
          'price_data' => [
              'currency' => 'eur',
              'product_data' => ['name' => $establishment->name],
              'unit_amount' => $establishment->frais_dossier * 100,
          ],
          'quantity' => 1,
      ]],
      'mode' => 'payment',
      'success_url' => url('/payment/success?session_id={CHECKOUT_SESSION_ID}'),
      'cancel_url' => url('/payment/cancel'),
  ]);
  ```
* Webhook `checkout.session.completed` â†’ met Ã  jour `applications.status = 'PayÃ©'` et stocke `receipt_url`.
* Aucune gÃ©nÃ©ration de PDF locale.

**C. Dashboard Ã‰tudiant**

* Bloc â€œğŸ’³ Mes paiementsâ€ : liste date, montant, statut, lien reÃ§u.
* Affiche `frais_dossier` (Sprint 1).
* PrÃ©parer champ `acompte_scolarite` (non encore payable).

#### ğŸ¨ UX / UI

* Design cohÃ©rent avec les autres sections du tableau de bord.
* Messages clairs selon le rÃ©sultat du paiement :

  * âœ… â€œPaiement validÃ©â€
  * âš ï¸ â€œPaiement annulÃ© ou Ã©chouÃ©â€
* IcÃ´nes de statut.

#### ğŸ”’ SÃ©curitÃ©

* ClÃ©s Stripe sÃ©curisÃ©es (server-side only).
* Validation utilisateur connectÃ©.
* Pas de duplication de paiement.

#### âŒ Ã€ ne pas faire

* Ne pas recrÃ©er une logique de facturation interne.
* Ne pas intÃ©grer dâ€™autres moyens de paiement.
* Ne pas stocker les donnÃ©es de carte.
* Ne pas casser la structure existante Stripe.

#### ğŸ“˜ TraÃ§abilitÃ©

```js
// Sprint1 Update: Feature 1.7.1 â€” Module Paiement (Stripe + acompte_scolarite)
```

`docs/qa/TEST_REPORT.md` â†’

```
Section â€œPaiement (Stripe)â€ â€” VÃ©rifier crÃ©ation session, redirection, statut PayÃ©, lien reÃ§u Stripe.
``